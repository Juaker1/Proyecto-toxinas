<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Filtro de toxinas Nav1.7 con búsqueda avanzada por motivos y características moleculares">
    <title>Filtro de Toxinas | Proyecto Toxinas</title>

    <!-- Preconexiones -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    
    <!-- Font Awesome (reinstalado para iconografía previa) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- CSS clave como bloqueante para evitar CLS por FOUC -->
    <link rel="stylesheet" href="{{ url_for('static', filename=asset_path('css/design-system.css')) }}">
    <link rel="stylesheet" href="{{ url_for('static', filename=asset_path('css/navbar.css')) }}">
    <link rel="stylesheet" href="{{ url_for('static', filename=asset_path('css/components.css')) }}">
    <link rel="stylesheet" href="{{ url_for('static', filename=asset_path('css/filter-page.css')) }}">
    <!-- Accesibilidad y estilos del viewer pueden ir diferidos -->
    <link rel="stylesheet" href="{{ url_for('static', filename=asset_path('css/accessibility.css')) }}" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="{{ url_for('static', filename=asset_path('css/accessibility.css')) }}"></noscript>
    <link rel="stylesheet" href="{{ url_for('static', filename=asset_path('css/viewer.css')) }}" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="{{ url_for('static', filename=asset_path('css/viewer.css')) }}"></noscript>
</head>
<body class="filter-page">
    <!-- NAVBAR -->
    {% include 'partials/navbar.html' %}

    <!-- CONTENIDO PRINCIPAL -->
    <div class="filter-container">

        <!-- Intro de la página -->
        <section class="page-intro" aria-labelledby="intro-title">
            <div class="intro-header">
                <div class="intro-icon" aria-hidden="true"><i class="fa-solid fa-microscope"></i></div>
                <div class="intro-texts">
                    <h1 id="intro-title" class="intro-title">Búsqueda de Toxinas Afines a NaV1.7</h1>
                    <p class="intro-lead">
                        Aplicación del farmacóforo funcional derivado de péptidos de veneno sobre la base de datos UniProt
                    </p>
                </div>
            </div>

            <!-- Grid de secciones explicativas -->
            <div class="intro-grid">
                <!-- Objetivo -->
                <div class="intro-section">
                    <div class="intro-section-icon" aria-hidden="true"><i class="fa-solid fa-bullseye"></i></div>
                    <h2 class="intro-section-title">Objetivo</h2>
                    <p class="intro-section-text">
                        Identificar toxinas peptídicas (reportadas y potenciales) con alta probabilidad de afinidad al canal de sodio NaV1.7, 
                        basándose en criterios estructurales y motivos funcionales validados experimentalmente.
                    </p>
                </div>

                <!-- Metodología -->
                <div class="intro-section">
                    <div class="intro-section-icon" aria-hidden="true"><i class="fa-solid fa-dna"></i></div>
                    <h2 class="intro-section-title">Motivo de Búsqueda</h2>
                    <p class="intro-section-text">
                        El patrón <span class="motif-badge">X<sub>1</sub>X<sub>2</sub>–S–WCK–X<sub>3</sub></span> identifica toxinas 
                        <strong>NaSpTx1</strong> con capacidad inhibidora de el canal <strong>NaV1.7</strong>. Localizado en el bucle posterior al quinto residuo <strong>Cys</strong> del andamiaje <em>ICK</em>, 
                        combina: <strong>S</strong> (inicio del bucle), <strong>W</strong> (residuo aromático crítico para orientar el farmacóforo), <strong>C</strong> (parte del sistema de puentes disulfuro del ICK), 
                        <strong>K</strong> (contacto electrostático con E810/D815/E817 del canal), y <strong>X<sub>1-3</sub></strong> (residuos hidrofóbicos que estabilizan la conformación del bucle).
                    </p>
                    <p class="intro-section-text" style="margin-top: 0.5rem; font-size: 0.9em; opacity: 0.9;">
                        Este motivo permite filtrar en UniProt secuencias que conservan la arquitectura mínima necesaria para presentar afinidad funcional hacia NaV1.7.
                    </p>
                </div>

                <!-- Referencia -->
                <div class="intro-section intro-section--highlight">
                    <div class="intro-section-icon" aria-hidden="true"><i class="fa-solid fa-file-lines"></i></div>
                    <h2 class="intro-section-title">Referencia Científica</h2>
                    <p class="intro-section-text">
                        Basado en el estudio publicado en <strong>FEBS Letters</strong>:
                    </p>
                    <div class="paper-reference">
                    <cite class="paper-title">
                            "Refining the NaV1.7 pharmacophore of a class of venom-derived peptide inhibitors via a combination of in silico screening and rational engineering"
                        </cite>
                        <a href="https://febs.onlinelibrary.wiley.com/doi/epdf/10.1002/1873-3468.70036" 
                           target="_blank" 
                           rel="noopener noreferrer" 
                           class="paper-link"
                           aria-label="Ver artículo completo en FEBS Letters (abre en nueva pestaña)">
                            <i class="fa-solid fa-external-link-alt" aria-hidden="true"></i>
                            <span>Ver artículo completo</span>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Controles de visualización mejorados -->
            <div class="visualization-controls" role="group" aria-label="Controles de visualización">
                <button id="btn-open-visuals" class="viz-toggle-card" aria-pressed="false" aria-controls="visualizations-section" data-viz-type="3d">
                    <div class="viz-card-icon">
                        <i class="fa-solid fa-cubes"></i>
                    </div>
                    <div class="viz-card-content">
                        <h3 class="viz-card-title">Visualizaciones 3D</h3>
                        <p class="viz-card-desc">Explora estructuras moleculares interactivas</p>
                    </div>
                    <div class="viz-card-status">
                        <span class="status-badge status-hidden">Oculto</span>
                        <i class="fa-solid fa-chevron-down viz-chevron"></i>
                    </div>
                </button>
                
                <button id="btn-open-charts" class="viz-toggle-card" aria-pressed="false" aria-controls="charts-card" data-viz-type="charts">
                    <div class="viz-card-icon">
                        <i class="fa-solid fa-chart-column"></i>
                    </div>
                    <div class="viz-card-content">
                        <h3 class="viz-card-title">Gráficos Analíticos</h3>
                        <p class="viz-card-desc">Visualiza métricas y distribuciones</p>
                    </div>
                    <div class="viz-card-status">
                        <span class="status-badge status-hidden">Oculto</span>
                        <i class="fa-solid fa-chevron-down viz-chevron"></i>
                    </div>
                </button>
            </div>
            
            <!-- Acceso rápido a tabla -->
            <div class="quick-nav">
                <a href="#results-card" class="quick-nav-link">
                    <i class="fa-solid fa-table-list" aria-hidden="true"></i>
                    <span>Ir a tabla de resultados</span>
                    <i class="fa-solid fa-arrow-down" aria-hidden="true"></i>
                </a>
            </div>
        </section>

        <!-- Sección de visualizaciones 3D (referencia + grilla) - oculta hasta clic -->
        <div class="visualization-section">
            <div id="visualizations-section" hidden inert>
            <div class="visualization-card">
                <div class="card-header card-header-row">
                    <h2 class="section-title reference-section-title">
                        <span aria-hidden="true"><i class="fa-solid fa-magnet"></i></span>
                        <span>Dipolo de Referencia:</span>
                        <select id="reference-selector" class="reference-selector-dropdown">
                        </select>
                        <code id="reference-sequence" class="reference-sequence">-</code>
                    </h2>
                    <div class="header-actions">
                        <button id="download-reference-btn" class="btn btn-secondary" title="Descargar PDB y PSF de la referencia">
                            <span aria-hidden="true"><i class="fa-solid fa-download"></i></span>
                            <span>Descargar</span>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="reference-viewer">
                        <div class="loading-state">
                            <div class="spinner" id="refSpinner"></div>
                            <p class="loading-text">Cargando referencia...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="visualization-card" id="filtered-dipoles-card">
                <div class="card-header card-header-row">
                    <h2 class="section-title"><span aria-hidden="true"><i class="fa-solid fa-bolt"></i></span> Dipolos de Toxinas Filtradas de UniProt</h2>
                    <div>
                        <button id="prev-page" class="btn btn-secondary" aria-label="Anterior"><i class="fa-solid fa-angle-left" aria-hidden="true"></i> Anterior</button>
                        <span id="page-indicator" class="page-indicator">Página 1</span>
                        <button id="next-page" class="btn btn-secondary" aria-label="Siguiente">Siguiente <i class="fa-solid fa-angle-right" aria-hidden="true"></i></button>
                    </div>
                </div>
                
                <!-- Botones de Modo de Visualización -->
                <div class="view-mode-controls">
                    <button id="showDipoleBtn" class="btn-view-mode active" data-mode="dipole">
                        <span aria-hidden="true"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M3 3h6v2H6.41L10 8.59 8.59 10 5 6.41V9H3V3zm12 0h6v6h-2V6.41L15.41 10 14 8.59 17.59 5H15V3zM3 15h2v2.59L8.59 14 10 15.41 6.41 19H9v2H3v-6zm18 0v6h-6v-2h2.59L14 15.41 15.41 14 19 17.59V15h2z"/></svg></span> Vectores Dipolares
                    </button>
                    <button id="showDisulfideBtn" class="btn-view-mode" data-mode="disulfide">
                        <span aria-hidden="true"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M10.59 13.41L9.17 12l4.24-4.24a3 3 0 114.24 4.24l-1.41 1.41-1.41-1.41 1.41-1.41a1 1 0 10-1.41-1.41L10.59 13.41zm-7.07 7.07a3 3 0 010-4.24l1.41-1.41 1.41 1.41-1.41 1.41a1 1 0 101.41 1.41L12 11.83 13.41 13.24 7.76 18.9a3 3 0 01-4.24 0z"/></svg></span> Puentes Disulfuro
                    </button>
                    <!-- 'Both' visualization removed per UI update -->
                </div>
                
                <div class="card-body">
                    <div id="filtered-grid" class="visualization-grid"></div>
                </div>
            </div>
            </div>

            <!-- Tarjeta fija de Gráficos (oculta hasta clic) -->
            <div class="visualization-card" id="charts-card" hidden inert>
                <div class="card-header card-header-row">
                    <h2 class="section-title"><span aria-hidden="true"><i class="fa-solid fa-chart-line"></i></span> Gráficos</h2>
                </div>
                <div class="card-body">
                    <div class="chart-block">
                        <h3 class="chart-title">IC50 (todas las páginas)</h3>
                        <div id="ic50-scatter-all" class="chart-canvas"></div>
                    </div>
                    <div class="chart-block chart-block--compact">
                        <h3 class="chart-title">Orientación (sin IC50)</h3>
                        <div id="ori-no-ic50-chart" class="chart-canvas chart-canvas--compact"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección de Filtros pulida -->
        <div class="filters-section">
            <div class="filters-header">
                <div class="filters-icon" aria-hidden="true"><i class="fa-solid fa-sliders"></i></div>
                <h2 class="filters-title">Configuración de Filtros</h2>
            </div>
            
            <div class="filters-grid">
                <div class="filter-input-group">
                    <label class="filter-label" for="gap-min">
                        <span class="filter-label-icon" aria-hidden="true"><i class="fa-solid fa-arrows-left-right"></i></span>
                        Gap Mínimo
                    </label>
                    <input id="gap-min" type="number" class="filter-input" value="3" min="1">
                </div>
                
                <div class="filter-input-group">
                    <label class="filter-label" for="gap-max">
                        <span class="filter-label-icon" aria-hidden="true"><i class="fa-solid fa-arrows-left-right"></i></span>
                        Gap Máximo
                    </label>
                    <input id="gap-max" type="number" class="filter-input" value="6" min="1">
                </div>
                
                <div class="filter-input-group">
                    <label class="checkbox-wrapper">
                        <div class="custom-checkbox" id="require-pair-box">
                            <input id="require-pair" type="checkbox" style="display: none;">
                        </div>
                        <span class="checkbox-label">
                            <span aria-hidden="true"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M10.59 13.41L9.17 12l4.24-4.24a3 3 0 114.24 4.24l-1.41 1.41-1.41-1.41 1.41-1.41a1 1 0 10-1.41-1.41L10.59 13.41z"/></svg></span>
                            Requerir Pareja Hidrofóbica
                        </span>
                    </label>
                </div>
            </div>
            
            <div class="filter-actions">
                <button id="run-filter" class="btn btn-primary btn-lg search-btn">
                    <span aria-hidden="true"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M10 2a8 8 0 105.293 14.293l4.707 4.707-1.414 1.414-4.707-4.707A8 8 0 0010 2zm0 2a6 6 0 110 12A6 6 0 0110 4z"/></svg></span>
                    <span>Buscar Toxinas</span>
                </button>
                <button id="export-xlsx" class="btn btn-secondary btn-export" disabled>
                    <span aria-hidden="true"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M4 2h10l6 6v14H4zM14 3.5V9h5.5L14 3.5zM7 12l2.5 3L7 18h2l1.5-2 1.5 2h2l-2.5-3 2.5-3h-2l-1.5 2-1.5-2H7z"/></svg></span> XLSX
                </button>
            </div>
            
            <div class="filter-status" id="status-line">
                <span class="status-icon" aria-hidden="true"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 100 20 10 10 0 000-20zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg></span>
                <span class="status-text">Listo para buscar</span>
            </div>
        </div>

        <!-- Tabla de Resultados - Diseño Moderno -->
        <div class="results-table-section" id="results-card">
            <div class="results-table-header">
                <!-- Título y contador -->
                <div class="results-title-wrapper">
                    <div class="results-icon" aria-hidden="true">
                        <i class="fa-solid fa-table-list"></i>
                    </div>
                    <h2 class="results-title">
                        Resultados del Filtro
                        <span class="results-count" id="hit-count">0</span>
                    </h2>
                </div>
                
                <!-- Controles de búsqueda y filtrado -->
                <div class="results-table-controls">
                    <div class="search-input-wrapper">
                        <i class="fa-solid fa-magnifying-glass search-icon" aria-hidden="true"></i>
                        <input 
                            id="accession-search" 
                            type="search" 
                            placeholder="Buscar por ID, nombre o accession..." 
                            aria-label="Buscar toxina por identificador"
                            autocomplete="off">
                        <button 
                            id="accession-clear" 
                            class="btn-clear-search" 
                            title="Limpiar búsqueda"
                            aria-label="Limpiar búsqueda">
                            <i class="fa-solid fa-xmark" aria-hidden="true"></i>
                        </button>
                    </div>
                    
                    <!-- Placeholder de tabs para no cambiar la altura al inyectarlos desde JS -->
                    <div id="tabs-placeholder" class="filter-mode-tabs"></div>
                </div>
                
                <!-- Botón de toggle -->
                <button id="toggle-results" class="toggle-table-btn" aria-expanded="true" aria-controls="results-body">
                    <i class="fa-solid fa-eye" aria-hidden="true"></i>
                    <span>Ocultar</span>
                </button>
            </div>
            
            <!-- Glosario de Residuos - Diseño completo con información detallada -->
            <div class="residue-glossary-full" style="display: none;" id="residue-glossary">
                <div class="glossary-header-full">
                    <div class="glossary-title-row">
                        <i class="fa-solid fa-book-open" aria-hidden="true"></i>
                        <h3>Glosario de Residuos Clave del Motivo Farmacofórico</h3>
                    </div>
                    <button class="glossary-toggle-btn" id="glossary-toggle" aria-expanded="true">
                        <i class="fa-solid fa-chevron-up"></i>
                    </button>
                </div>
                <div class="glossary-content" id="glossary-content">
                    <div class="glossary-grid-full">
                        <div class="glossary-card">
                            <span class="residue-badge-full" style="background: #DC2626; color: white;">C</span>
                            <p class="residue-text"><strong>Cisteínas ICK</strong> — Puentes disulfuro I–IV, II–V, III–VI (6 Cys obligatorias)</p>
                        </div>
                        
                        <div class="glossary-card">
                            <span class="residue-badge-full" style="background: #9333EA; color: white;">C₅</span>
                            <p class="residue-text"><strong>Quinta Cys</strong> — Marca inicio del loop farmacofórico</p>
                        </div>
                        
                        <div class="glossary-card">
                            <span class="residue-badge-full" style="background: #10B981; color: white;">C</span>
                            <p class="residue-text"><strong>C del motivo WCK</strong> — Sexta Cys, parte del farmacóforo</p>
                        </div>
                        
                        <div class="glossary-card">
                            <span class="residue-badge-full" style="background: #2563EB; color: white;">S</span>
                            <p class="residue-text"><strong>Serina</strong> — Inicio del bucle funcional post-Cys₅</p>
                        </div>
                        
                        <div class="glossary-card">
                            <span class="residue-badge-full" style="background: #EA580C; color: white;">W</span>
                            <p class="residue-text"><strong>Triptófano</strong> — Ancla aromática crítica para VSD-II</p>
                        </div>
                        
                        <div class="glossary-card">
                            <span class="residue-badge-full" style="background: #EAB308; color: #000;">K</span>
                            <p class="residue-text"><strong>Lisina</strong> — Contacto electrostático (E810, D815, E817)</p>
                        </div>
                        
                        <div class="glossary-card">
                            <span class="residue-badge-full" style="background: #92400E; color: white;">X₁X₂</span>
                            <p class="residue-text"><strong>Par hidrofóbico</strong> — Estabilizan orientación del W</p>
                        </div>
                        
                        <div class="glossary-card">
                            <span class="residue-badge-full" style="background: #84CC16; color: #000;">X₃</span>
                            <p class="residue-text"><strong>Hidrofóbico final</strong> — Completa geometría del loop</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="results-table-wrapper" id="results-body">
                <!-- Estado vacío inicial -->
                <div id="empty-state" class="empty-state" style="display: none;">
                    <div class="empty-state-icon">
                        <i class="fa-solid fa-flask-vial"></i>
                    </div>
                    <h3 class="empty-state-title">No hay resultados aún</h3>
                    <p class="empty-state-description">
                        Configura los filtros arriba y haz clic en "Buscar Toxinas" para ver los resultados de tu búsqueda.
                    </p>
                    <button class="empty-state-action" onclick="document.getElementById('run-filter').click()">
                        <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
                        <span>Buscar Ahora</span>
                    </button>
                </div>
                
                <!-- Tabla de resultados -->
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>
                                ID Péptido
                                <span class="header-help-icon" title="Identificador único del péptido en la base de datos UniProt. Ejemplo: P0DL84, D2Y1Y1">?</span>
                            </th>
                            <th>
                                Nombre
                                <span class="header-help-icon" title="Nombre sistemático de la toxina según nomenclatura estándar. Ejemplo: μ-TRTX-Hh2a indica tipo μ (mu), familia TRTX (tarantula toxin), especie Hh (Haplopelma hainanum), variante 2a">?</span>
                            </th>
                            <th>
                                Gap
                                <span class="header-help-icon" title="Distancia en aminoácidos entre las cisteínas clave del motivo. Rango configurado: 3-6 residuos. Importante para la estructura terciaria">?</span>
                            </th>
                            <th>
                                X3
                                <span class="header-help-icon" title="Aminoácido en posición X3 del motivo funcional. Residuos comunes: V (Valina), Y (Tirosina), F (Fenilalanina). Crítico para selectividad Nav1.7">?</span>
                            </th>
                            <th>
                                Par?
                                <span class="header-help-icon" title="Indica presencia de par hidrofóbico conservado (✓ = presente, — = ausente). Pares hidrofóbicos estabilizan la estructura y pueden afectar la afinidad">?</span>
                            </th>
                            <th>
                                Par Hidrofóbico
                                <span class="header-help-icon" title="Residuos específicos que forman el par hidrofóbico. Ejemplos: YA (Tyr-Ala), LV (Leu-Val), WF (Trp-Phe). Interacciones no polares importantes">?</span>
                            </th>
                            <th>
                                Score Par
                                <span class="header-help-icon" title="Índice de hidrofobicidad del par (escala Kyte-Doolittle). Rango 0.50-8.00. Valores >5 indican alta hidrofobicidad. Usado para predecir interacciones membrana">?</span>
                            </th>
                            <th>
                                Long.
                                <span class="header-help-icon" title="Longitud total de la cadena peptídica en residuos de aminoácidos. Toxinas Nav típicas: 30-40 aa. Determina tamaño molecular y complejidad estructural">?</span>
                            </th>
                            <th>
                                Secuencia
                                <span class="header-help-icon" title="Secuencia primaria completa (código 1 letra). Residuos coloreados según glosario: Rojo=Cys ICK, Morado=Cys₅, Verde=C del WCK, Azul=S, Naranja=W, Amarillo=K, Café=X₁X₂, Verde claro=X₃">?</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="motif-body">
                        <!-- Las filas se cargan dinámicamente -->
                    </tbody>
                </table>
                
                <!-- Paginación moderna -->
                <div class="results-header" style="margin-top: var(--space-4); padding: var(--space-4); background: var(--gray-50); border-radius: var(--radius-lg);">
                    <div class="pagination-controls">
                        <button id="tbl-prev" class="pagination-btn" aria-label="Página anterior">
                            <i class="fa-solid fa-chevron-left" aria-hidden="true"></i>
                            <span>Anterior</span>
                        </button>
                        <span id="tbl-page" class="page-indicator">Página 1</span>
                        <button id="tbl-next" class="pagination-btn" aria-label="Página siguiente">
                            <span>Siguiente</span>
                            <i class="fa-solid fa-chevron-right" aria-hidden="true"></i>
                        </button>
                    </div>
                    <div style="color: var(--gray-600); font-size: var(--text-sm); text-align: center;">
                        <i class="fa-solid fa-circle-info" aria-hidden="true"></i>
                        <span id="pagination-info">Mostrando resultados filtrados</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SheetJS se carga on-demand desde toxin_filter.js al presionar Exportar (se usa build xlsx.core.min.js) -->
    
    <!-- py3Dmol y Plotly se cargan on-demand desde motif_dipoles.js para minimizar trabajo en main thread -->
    
    <!-- Custom scripts con defer -->
    <script src="{{ url_for('static', filename=asset_path('js/navbar.js')) }}" defer></script>
    <script src="{{ url_for('static', filename=asset_path('js/ui-enhancements.js')) }}" defer></script>
    <script src="{{ url_for('static', filename=asset_path('js/toxin_filter.js')) }}" defer></script>
    <script src="{{ url_for('static', filename=asset_path('js/motif_dipoles.js')) }}" defer></script>
</body>
</html>